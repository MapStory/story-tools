!function(){"use strict";angular.module("storytools.core.mapstory",["storytools.core.mapstory.services"])}(),function(){var e=angular.module("storytools.core.loading.directives",[]);e.directive("stLoading",function(){return{restrict:"C",templateUrl:"loading/loading.html",scope:{spinnerHidden:"="},link:function(e,t,o){e.spinnerWidth=3,e.spinnerRadius=28,goog.isDefAndNotNull(o.spinnerWidth)&&(e.spinnerWidth=parseInt(o.spinnerWidth,10)),goog.isDefAndNotNull(o.spinnerRadius)&&(e.spinnerRadius=parseInt(o.spinnerRadius,10));var r=t.find(".loading");r.css("width",e.spinnerRadius+"px"),r.css("height",e.spinnerRadius+"px"),r.css("margin","-"+e.spinnerRadius/2+"px 0 0 -"+e.spinnerRadius/2+"px");var n=t.find(".loading-spinner");n.css("width",e.spinnerRadius-e.spinnerWidth+"px"),n.css("height",e.spinnerRadius-e.spinnerWidth+"px"),n.css("border",e.spinnerWidth+"px solid"),n.css("border-radius",e.spinnerRadius/2+"px");var i=t.find(".mask");i.css("width",e.spinnerRadius/2+"px"),i.css("height",e.spinnerRadius/2+"px");var a=t.find(".spinner");a.css("width",e.spinnerRadius+"px"),a.css("height",e.spinnerRadius+"px")}}})}(),function(){"use strict";angular.module("storytools.core.loading",["storytools.core.loading.directives"])}(),function(){"use strict";function e(){this.storyBoxes=[],this.map=null}var t=angular.module("storytools.core.boxes",[]),o=storytools.core.maps.boxes;e.prototype.boxesChanged=function(e,t){var o;if("delete"==t){for(o=0;o<e.length;o++)for(var r=e[o],n=0,i=this.storyBoxes.length;i>n;n++)if(this.storyBoxes[n].id==r.id){this.storyBoxes.splice(n,1);break}}else if("add"==t)for(o=0;o<e.length;o++)this.storyBoxes.push(e[o]);else if("change"!=t)throw new Error("action? :"+t);var a=this.storyBoxes.map(function(e){return e.range});this.map.storyBoxesLayer.set("times",a),this.map.storyBoxesLayer.set("features",this.storyBoxes)},e.prototype.loadFromGeoJSON=function(e,t,r){if(r&&(this.storyBoxes=[]),e&&e.features){var n=o.loadFromGeoJSON(e,t);this.boxesChanged(n,"add",!0)}},t.service("StoryBoxLayerManager",e),t.constant("StoryBox",o.Box)}(),function(){"use strict";var e=angular.module("storytools.core.legend.directives",[]),t=!1;e.directive("stLegend",["$rootScope","MapManager",function(e,o){return{restrict:"C",replace:!0,templateUrl:"legend/legend.html",link:function(e){e.mapManager=o;var r=function(){angular.element(document.getElementById("legend-container"))[0].style.visibility="visible",angular.element(document.getElementById("legend-panel"))[0].style.display="block",t=!0},n=function(){angular.element(document.getElementById("legend-panel"))[0].style.display="none",t=!1,setTimeout(function(){angular.element("#legend-container")[0].style.visibility="hidden"},350)};e.toggleLegend=function(){t===!1?(console.log(angular.element(document.getElementsByClassName("legend-item"))),r()):n()},e.getLegendUrl=function(e){var t=null,o="/geoserver/wms",r=e.get("typeName")||e.get("id");return t=o+"?request=GetLegendGraphic&format=image%2Fpng&width=20&height=20&layer="+r+"&transparent=true&legend_options=fontColor:0xFFFFFF;fontAntiAliasing:true;fontSize:14;fontStyle:bold;",e.get("params").STYLES&&(t+="&style="+e.get("params").STYLES),t},e.$on("layer-added",function(){t===!1&&r()}),e.$on("layerRemoved",function(){t===!0&&1==angular.element(".legend-item").length&&n()})}}}])}(),function(){"use strict";angular.module("storytools.core.legend",["storytools.core.legend.directives"])}(),function(){"use strict";var e=angular.module("storytools.core.measure.directives",[]);e.directive("stMeasurepanel",["$rootScope","MapManager",function(e,t){return{replace:!0,templateUrl:"measure/measurepanel.tpl.html",link:function(e){e.mapManager=t,e.isMeasuring=!1,e.feature=null,e.measureType="",e.source=new ol.source.Vector,e.layer=new ol.layer.Vector({source:e.source}),e.units="m",e.unitTypes=[{type:"m",label:"M/KM"},{type:"mi",label:"Mi"},{type:"ft",label:"Ft"}],e.changeUnits=function(t){e.units=t},e.measureLabel=0,e.unitsLabel="",e.interaction=null;var o=function(t){return new ol.interaction.Draw({source:e.source,type:"line"==t?"LineString":"Polygon"})},r=new ol.Sphere(6378137),n=t.storyMap.getMap().getView().getProjection();e.updateMeasure=function(){var t=e.feature.getGeometry(),o=t.clone().transform(n,"EPSG:4326"),i=[];if(t instanceof ol.geom.Polygon){if(i=o.getLinearRing(0).getCoordinates(),i.length>2){var a=Math.abs(r.geodesicArea(i));a>1e6&&"m"==e.units?(a/=1e6,e.unitsLabel="km^2"):"ft"==e.units?(a=10.7639*a,e.unitsLabel="ft^2"):"mi"==e.units?(a=a/1e3*386102e-9,e.unitsLabel="mi^2"):e.unitsLabel="m^2",e.measureLabel=a,e.feature.set("measureLabel",a),e.$apply()}}else{var s=0;if(i=o.getCoordinates(),i.length>1){for(var l=1,u=i.length;u>l;l++)s+=r.haversineDistance(i[l-1],i[l]);s>1e3&&"m"==e.units?(s/=1e3,e.unitsLabel="km"):"ft"==e.units?(s=3.28084*s,e.unitsLabel="ft"):"mi"==e.units?(s/=1609,e.unitsLabel="mi"):e.unitsLabel="m",e.measureLabel=s,e.feature.set("measureLabel",s),e.$apply()}}},e.startMeasuring=function(r){e.isMeasuring&&e.stopMeasuring(),e.measureType=r,t.storyMap.getMap().addLayer(e.layer),e.interaction=o(r),t.storyMap.getMap().addInteraction(e.interaction),e.interaction.on("drawstart",function(t){e.source.clear(),e.measureLabel=0,e.feature=t.feature,e.feature.set("id","measure-tool"),e.feature.getGeometry().on("change",e.updateMeasure)}),e.isMeasuring=!0},e.stopMeasuring=function(){t.storyMap.getMap().removeLayer(e.layer),e.measureLabel=0,null!==e.interaction&&t.storyMap.getMap().removeInteraction(e.interaction),e.measureType="",e.isMeasuring=!1}}}}])}(),function(){"use strict";angular.module("storytools.core.measure",["storytools.core.measure.directives"])}(),function(){"use strict";var e=angular.module("storytools.core.ogc.directives",[]);e.directive("featureinfobox",["MapManager","$rootScope","stFeatureInfoService",function(e,t,o){return{replace:!1,restrict:"A",templateUrl:"ogc/featureinfobox.tpl.html",link:function(t){t.mapManager=e,t.featureInfoService=o,t.isUrl=function(e){return/^(f|ht)tps?:\/\//i.test(e)?!0:!1},t.isShowingAttributes=function(){var e=null;if(!goog.isDefAndNotNull(e))return!0;for(var t=featureInfoService.getSelectedItemProperties(),o=0;o<t.length;o++)if(goog.isDefAndNotNull(e[t[o][0]])&&e[t[o][0]].visible)return!0;return!1},t.isAttributeVisible=function(e){var t=null;return goog.isDefAndNotNull(t)&&t.hasOwnProperty(e)?t[e].visible:!0}}}}])}(),function(){"use strict";function e(e){ol.Object.call(this,e),this.map_=new ol.Map({target:e.target,pixelRatio:1,controls:ol.control.defaults().extend([new ol.control.MousePosition({projection:"EPSG:4326",coordinateFormat:ol.coordinate.toStringHDMS}),new ol.control.ScaleLine({className:"metric-scale-line ol-scale-line",units:ol.control.ScaleLineUnits.METRIC}),new ol.control.ScaleLine({className:"imperial-scale-line ol-scale-line",units:ol.control.ScaleLineUnits.IMPERIAL}),a])}),this.overlay=new ol.layer.Vector({map:this.map_,style:i}),e.overlayElement&&this.map_.addOverlay(new ol.Overlay({element:e.overlayElement,stopEvent:!0})),this.title="Default Mapstory",this.abstract="No Information Supplied.",this.owner="",this.mode="instant",this.returnToExtent=e.returnToExtent||!1,this.center=[0,0],this.zoom=2,this.storyLayers_=new ol.Collection,this.animationDuration_=e.animationDuration||500,this.storyBoxesLayer=new o({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:i})}),this.storyPinsLayer=new o({timeAttribute:"start_time",endTimeAttribute:"end_time",layer:new ol.layer.Vector({source:new ol.source.Vector,style:i})}),this.addStoryPinsLayer(),this.addStoryBoxesLayer()}function t(t){e.call(this,t)}function o(e){var t={};e.times&&storytools.core.time.utils.isRangeLike(e.times)&&(e.times=new storytools.core.time.utils.Interval(e.times)),ol.Object.call(this,e);var o;if("VECTOR"===this.get("type")){var r=new ol.source.Vector({});if(e.cluster){var n=new ol.source.Cluster({distance:20,source:r});t={source:n,style:e.style||i}}else t={source:r,style:e.style||i};o=new ol.layer.Vector(t),e.animate&&window.setInterval(function(){r.dispatchEvent("change")},1e3/75)}else if("HEATMAP"===this.get("type"))o=new ol.layer.Heatmap({radius:e.style.radius,opacity:e.style.opacity,source:new ol.source.Vector});else if("WMS"===this.get("type")){var a={useOldAsInterimTiles:!0};o=this.get("singleTile")===!0?new ol.layer.Image(a):new ol.layer.Tile(a)}else o=e.layer;this.layer_=o}function r(e){o.call(this,e)}var n=angular.module("storytools.core.ogc",["storytools.core.ogc.directives","storytools.core.ogc.services"]),i=[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1}),image:new ol.style.Circle({radius:10,fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"red",width:1})})})];$("#map .metric-scale-line").css("bottom","-=40px"),$("#map .imperial-scale-line").css("bottom","-=40px"),$("#map .nautical-scale-line").css("bottom","-=40px"),$("#map .ol-mouse-position").css("bottom","-=40px"),$("#switch-coords-border").css("bottom","-=40px");var a=new ol.control.ScaleLine({className:"nautical-scale-line ol-scale-line",units:ol.control.ScaleLineUnits.NAUTICAL,render:function(e){var t=e.frameState;this.viewState_=t?t.viewState:null;var o=this.viewState_;if(!o)return void(this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1));var r=o.center,n=o.projection,i=n.getMetersPerUnit(),a=n.getPointResolution(o.resolution,r)*i;a/=1852;var s="nm",l=20,u=Math.round(l/a),c=l+" "+s;return this.renderedHTML_!=c&&(this.innerElement_.innerHTML=c,this.renderedHTML_=c),u>.6*e.frameState.size[0]||15>u?(this.element_.style.display="none",void(this.renderedVisible_=!1)):(this.renderedWidth_!=u&&(this.innerElement_.style.width=u+"px",this.renderedWidth_=u),void(this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0)))}});e.prototype=Object.create(ol.Object.prototype),e.prototype.constructor=e,e.prototype.addStoryPinsLayer=function(){this.map_.addLayer(this.storyPinsLayer.getLayer())},e.prototype.addStoryBoxesLayer=function(){this.map_.addLayer(this.storyBoxesLayer.getLayer())},e.prototype.setStoryOwner=function(e){this.owner=e},e.prototype.getStoryOwner=function(){return this.owner},e.prototype.getCenter=function(){return this.center},e.prototype.getZoom=function(){return this.zoom},e.prototype.setStoryTitle=function(e){this.title=e},e.prototype.setCenter=function(e){this.center=e},e.prototype.setZoom=function(e){this.zoom=e},e.prototype.setMode=function(e){this.mode=e},e.prototype.setStoryAbstract=function(e){this.abstract=e},e.prototype.getStoryTitle=function(){return this.title},e.prototype.getStoryAbstract=function(){return this.abstract},e.prototype.setBaseLayer=function(e){this.set("baselayer",e),this.map_.getLayers().forEach(function(e){"background"===e.get("group")&&this.map_.removeLayer(e)},this),this.map_.getLayers().insertAt(0,this.get("baselayer"))},e.prototype.addStoryLayer=function(e){e.storyMap_=this,this.storyLayers_.push(e);var t=this.map_.getLayers().getLength(),o=this;this.map_.getLayers().forEach(function(e){(e===o.storyPinsLayer||e instanceof ol.layer.Vector)&&(t-=1)}),this.map_.getLayers().insertAt(t,e.getLayer())},e.prototype.getStoryLayers=function(){return this.storyLayers_},e.prototype.getMap=function(){return this.map_},e.prototype.clear=function(){this.map_.getLayers().clear(),this.storyLayers_.clear(),this.addStoryPinsLayer()},e.prototype.animatePanAndBounce=function(e,t){var o=2e3,r=+new Date,n=this.map_.getView();if(n.getCenter()!=e){var i=ol.animation.pan({duration:this.animationDuration_,source:n.getCenter(),start:r}),a=ol.animation.bounce({duration:o,resolution:2*n.getResolution(),start:r});this.map_.beforeRender(i,a),n.setCenter(e),n.setZoom(t)}},e.prototype.animateCenterAndZoom=function(e,t){var o=this.map_.getView();(o.getCenter()!==e||o.getZoom()!==t)&&(this.map_.beforeRender(ol.animation.pan({duration:this.animationDuration_,source:o.getCenter()})),o.setCenter(e),this.map_.beforeRender(ol.animation.zoom({resolution:o.getResolution(),duration:this.animationDuration_})),o.setZoom(t))},e.prototype.setAllowPan=function(e){this.map_.getInteractions().forEach(function(t){(t instanceof ol.interaction.KeyboardPan||t instanceof ol.interaction.DragPan)&&t.setActive(e)})},e.prototype.setAllowZoom=function(e){var t;this.map_.getControls().forEach(function(e){e instanceof ol.control.Zoom&&(t=e)}),e?this.map_.addControl(new ol.control.Zoom):this.map_.removeControl(t),this.map_.getInteractions().forEach(function(t){(t instanceof ol.interaction.DoubleClickZoom||t instanceof ol.interaction.PinchZoom||t instanceof ol.interaction.DragZoom||t instanceof ol.interaction.MouseWheelZoom)&&t.setActive(e)})},e.prototype.toggleStoryLayer=function(e){var t=e.getLayer();e.set("visibility",!t.getVisible()),t.setVisible(!t.getVisible())},n.constant("StoryMap",e),t.prototype=Object.create(e.prototype),t.prototype.constructor=t,n.constant("EditableStoryMap",t),t.prototype.getState=function(){var e={};e.map={center:this.map_.getView().getCenter(),projection:this.map_.getView().getProjection().getCode(),zoom:this.map_.getView().getZoom(),layers:[]};var t=this.get("id");t>=0&&(e.id=t);var o=this.get("baselayer");if(o){var r=this.get("baselayer").get("state");r.group="background",r.visibility=!0,e.map.layers.push(r)}return this.storyLayers_.forEach(function(t){e.map.layers.push(t.getState())}),e},t.prototype.removeStoryLayer=function(e){this.storyLayers_.remove(e),this.map_.removeLayer(e.getLayer())},o.prototype=Object.create(ol.Object.prototype),o.prototype.constructor=o,o.prototype.getStoryMap=function(){return this.storyMap_},o.prototype.setWMSSource=function(){var e=this.getLayer(),t=this.get("name"),o=this.get("times"),r=this.get("singleTile"),n=this.get("params")||{LAYERS:t,VERSION:"1.1.0",TILED:!0};if(o&&(n.TIME=new Date(o.start||o[0]).toISOString()),r)e.setSource(new ol.source.ImageWMS({params:n,url:this.get("url"),serverType:"geoserver"}));else{var i,a=this.get("resolutions"),s=this.get("bbox");a&&s&&(i=new ol.tilegrid.TileGrid({extent:s,resolutions:a})),e.setSource(new ol.source.TileWMS({url:this.get("url"),params:n,tileGrid:i,serverType:"geoserver"}))}},o.prototype.getState=function(){var e=this.getProperties();return delete e.features,e},o.prototype.getLayer=function(){return this.layer_},o.prototype.setLayer=function(e){if(this.layer_&&this.storyMap_){var t=this.storyMap_.map_,o=t.getLayers().getArray().indexOf(this.layer_);t.getLayers().setAt(o,e)}this.layer_=e},n.constant("StoryLayer",o),r.prototype=Object.create(o.prototype),r.prototype.constructor=r,n.constant("EditableStoryLayer",r),n.service("stAnnotateLayer",["$rootScope","$http","$q",function(e,t,o){return{loadCapabilities:function(o){var r="GetCapabilities",n="WMS",i=o.get("url");if("/geoserver/wms"===i){var a=o.get("name"),s=a.split(":");i=i.replace("/geoserver","/geoserver/"+s[0]+"/"+s[1])}return i=i.replace("http:",""),e.$broadcast("layer-status",{name:o.get("name"),phase:"capabilities",status:"loading"}),t({method:"GET",url:i,params:{REQUEST:r,SERVICE:n,VERSION:"1.3.0",TILED:!0}}).then(function(t){var r=new owsjs.Jsonix.Context([owsjs.mappings.XLink_1_0,owsjs.mappings.WMS_1_3_0]),n=r.createUnmarshaller(),i=n.unmarshalString(t.data),a=i.value.capability.layer;o.set("latlonBBOX",[parseFloat(a.boundingBox[0].minx),parseFloat(a.boundingBox[0].miny),parseFloat(a.boundingBox[0].maxx),parseFloat(a.boundingBox[0].maxy)]);for(var s=i.value.capability.vendorSpecificCapabilities,l=s?s.tileSet||[]:[],u=0,c=l.length;c>u;++u)if("EPSG:900913"===l[u].srs){o.set("resolutions",l[u].resolutions.split(" "));var p=l[u].boundingBox;o.set("bbox",[parseFloat(p.minx),parseFloat(p.miny),parseFloat(p.maxx),parseFloat(p.maxy)]);break}var g=storytools.core.time.maps.readCapabilitiesTimeDimensions(i),y=o.get("name");y in g&&o.set("times",g[y]),e.$broadcast("layer-status",{name:o.get("name"),phase:"capabilities",status:"done"})}).catch(function(){})},describeFeatureType:function(o){var r=this,n="DescribeFeatureType",i="WFS",a=o.get("id");return e.$broadcast("layer-status",{name:o.get("name"),phase:"featureType",status:"loading"}),t({method:"GET",url:o.get("url").replace("http:",""),params:{SERVICE:i,VERSION:"1.0.0",REQUEST:n,TYPENAME:a}}).then(function(t){var n=storytools.edit?new storytools.edit.WFSDescribeFeatureType.WFSDescribeFeatureType:null;if(n){var i=n.parseResult(t.data);i.timeAttribute?o.set("timeAttribute",i.timeAttribute):o.get("timeEndpoint")&&r.getTimeAttribute(o);var s=a.split(":");o.set("typeName",a),o.set("featurePrefix",s[0]),o.set("featureNS",i.featureNS),o.set("geomType",i.geomType),o.set("attributes",i.attributes)}e.$broadcast("layer-status",{name:o.get("name"),phase:"featureType",status:"done"})}).catch(function(){})},getTimeAttribute:function(e){return t({method:"GET",url:e.get("timeEndpoint")}).then(function(t){e.set("timeAttribute",t.data.attribute),data.endAttribute&&e.set("endTimeAttribute",t.data.endAttribute)}).catch(function(){})},getStyleName:function(e){if(e.get("canStyleWMS")){return t({method:"GET",url:e.get("path")+"rest/layers/"+e.get("id")+".json"}).then(function(t){e.set("styleName",t.data.layer.defaultStyle.name)}).catch(function(){})}return o.when("")},getFeatures:function(o,r){var n=o.get("id"),i=o.get("cql"),a=o.get("url")+"?service=WFS&version=1.1.0&request=GetFeature&typename="+n+"&outputFormat=application/json&srsName="+r.getView().getProjection().getCode();return i&&(a+="&cql_filter="+i),a+="&t="+(new Date).getTime(),e.$broadcast("layer-status",{name:o.get("name"),phase:"features",status:"loading"}),t({method:"GET",url:a}).then(function(t){var r=o.getLayer(),n=o.get("filter"),i=(new ol.format.GeoJSON).readFeatures(t.data);n&&(i=n(i)),o.set("features",i),r.getSource()instanceof ol.source.Cluster?(r.getSource().getSource().clear(!0),r.getSource().getSource().addFeatures(i)):r.getSource()instanceof ol.source.Vector&&(r.getSource().clear(!0),r.getSource().addFeatures(i)),e.$broadcast("layer-status",{name:o.get("name"),phase:"features",status:"done"})}).catch(function(){})}}}]),n.service("stBaseLayerBuilder",function(){return{buildLayer:function(e){if("MapQuest"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.MapQuest({layer:e.layer})});if("ESRI"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.XYZ({attributions:[new ol.Attribution({html:'Tiles &copy; <a href="//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer">ArcGIS</a>'})],url:"//server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}"})});if("HOT"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.OSM({attributions:[new ol.Attribution({html:'Tiles courtesy of <a href="//hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'}),ol.source.OSM.ATTRIBUTION],crossOrigin:null,url:"//{a-c}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"})});if("OSM"===e.type)return new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background",source:new ol.source.OSM});if("MapBox"===e.type){var t=new ol.layer.Tile({state:e,name:e.title,title:e.title,group:"background"}),o=e.name,r=["//a.tiles.mapbox.com/v1/mapbox.","//b.tiles.mapbox.com/v1/mapbox.","//c.tiles.mapbox.com/v1/mapbox.","//d.tiles.mapbox.com/v1/mapbox."],n=function(e){var t=e;return t[1]<0||t[2]<0?"":r[Math.round(3*Math.random())]+o+"/"+t[0].toString()+"/"+t[1].toString()+"/"+t[2].toString()+".png"};return t.setSource(new ol.source.TileImage({crossOrigin:null,attributions:[new ol.Attribution({html:/^world/.test(o)?"<a href='//mapbox.com'>MapBox</a> | Some Data &copy; OSM CC-BY-SA | <a href='//mapbox.com/tos'>Terms of Service</a>":"<a href='//mapbox.com'>MapBox</a> | <a href='//mapbox.com/tos'>Terms of Service</a>"})],tileGrid:new ol.tilegrid.TileGrid({origin:[-20037508.34,-20037508.34],resolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,.5971642833948135]}),tileUrlFunction:n})),t}if("WMS"===e.type)return new ol.layer.Tile({group:"background",source:new ol.source.TileWMS({url:e.url,params:e.params})});throw new Error("no type for : "+JSON.stringify(e))}}}),n.service("stEditableLayerBuilder",["$q","stAnnotateLayer","stBaseLayerBuilder",function(e,t){return{buildEditableLayer:function(o,n){var i=new r(o),a=e.defer(),s=[],l=!(o.latlonBBOX&&o.times);l&&s.push(t.loadCapabilities(i));var u=!o.attributes;return u&&s.push(t.describeFeatureType(i)),s.push("VECTOR"!==o.type&&"HEATMAP"!==o.type||o.features?t.getStyleName(i):t.getFeatures(i,n)),e.all(s).then(function(){if(i.get("features")){var e=i.get("times");if(e){var t=e.start||e[0];storytools.core.time.maps.filterVectorLayer(i,{start:t,end:t})}else i.getLayer().getSource().addFeatures(i.get("features"))}else i.setWMSSource();a.resolve(i)},function(){a.reject(arguments)}),a.promise}}}]),n.service("stLayerBuilder",["$q",function(e){return{buildLayer:function(t){var r=new o(t),n=e.defer();return r.setWMSSource(),n.resolve(r),n.promise}}}]),n.service("stStoryMapBaseBuilder",["$rootScope","$compile","stBaseLayerBuilder",function(e,t,o){return{defaultMap:function(e){e.getMap().setView(new ol.View({center:[0,0],zoom:3,minZoom:3,maxZoom:16})),this.setBaseLayer(e,{title:"World Topo Map",type:"ESRI",name:"world-topo-map"})},setBaseLayer:function(e,t){var r=o.buildLayer(t);e.setBaseLayer(r)}}}]),n.service("stStoryMapBuilder",["$rootScope","$compile","stLayerBuilder","stStoryMapBaseBuilder",function(e,t,o,r){return{modifyStoryMap:function(e,t){e.clear();var n=storytools.mapstory.MapConfigTransformer.MapConfigTransformer(t);n.id>=0&&(e.set("id",n.id),e.setMode(n.playbackMode),void 0!==t.about&&(e.setStoryTitle(t.about.title),e.setStoryAbstract(t.about.abstract),e.setStoryOwner(t.about.owner)),e.setCenter(n.map.center),e.setZoom(n.map.zoom));for(var i=0,a=n.map.layers.length;a>i;++i){var s=n.map.layers[i];"background"===s.group&&s.visibility===!0?r.setBaseLayer(e,s):o.buildLayer(s,e.getMap()).then(function(t){e.addStoryLayer(t)})}e.getMap().setView(new ol.View({center:n.map.center,zoom:n.map.zoom,minZoom:3,maxZoom:17}))}}}]),n.service("stEditableStoryMapBuilder",["$rootScope","$compile","stStoryMapBaseBuilder","stEditableLayerBuilder",function(e,t,o,r){return{modifyStoryLayer:function(e,t){var o=e.getProperties(),n=e.getStoryMap();return o.type=t?t:"WMS"===o.type?"VECTOR":"WMS","WMS"===o.type&&delete o.features,r.buildEditableLayer(o,n.getMap()).then(function(t){e.setLayer(t.getLayer()),e.set("type",t.get("type"))})},modifyStoryMap:function(e,t){e.clear();var n=storytools.mapstory.MapConfigTransformer.MapConfigTransformer(t);n.id>=0&&(e.set("id",n.id),e.setMode(n.playbackMode),void 0!==t.about&&(e.setStoryTitle(t.about.title),e.setStoryAbstract(t.about.abstract),e.setStoryOwner(t.about.owner)));for(var i=0,a=n.map.layers.length;a>i;++i){var s=n.map.layers[i];"background"===s.group&&s.visibility===!0?o.setBaseLayer(e,s):r.buildEditableLayer(s,e.getMap()).then(function(t){e.addStoryLayer(t)})}e.getMap().setView(new ol.View({center:n.map.center,zoom:n.map.zoom,projection:n.map.projection,minZoom:3,maxZoom:17}))}}}]),ol.Overlay.Popup=function(e){var t=e||{};this.panMapIfOutOfView=t.panMapIfOutOfView,void 0===this.panMapIfOutOfView&&(this.panMapIfOutOfView=!0),this.ani=t.ani,void 0===this.ani&&(this.ani=ol.animation.pan),this.ani_opts=t.ani_opts,void 0===this.ani_opts&&(this.ani_opts={duration:250}),this.container=document.createElement("div"),this.container.className="ol-popup",this.container.id=t.hasOwnProperty("id")?t.id:"",this.closer=document.createElement("a"),this.closer.className="ol-popup-closer",this.closer.href="#",this.container.appendChild(this.closer);var o=this;this.closer.addEventListener("click",function(e){o.container.style.display="none",o.closer.blur(),e.preventDefault()},!1),this.content=document.createElement("div"),this.content.className="ol-popup-content",this.container.appendChild(this.content),ol.Overlay.call(this,{id:t.hasOwnProperty("id")?t.id:"popup",element:this.container,positioning:t.hasOwnProperty("positioning")?t.positioning:"top-left",stopEvent:t.hasOwnProperty("stopEvent")?t.stopEvent:!0,insertFirst:t.hasOwnProperty("insertFirst")?t.insertFirst:!0})},ol.inherits(ol.Overlay.Popup,ol.Overlay),ol.Overlay.Popup.prototype.getId=function(){return this.container.id},ol.Overlay.Popup.prototype.show=function(e,t){return this.setPosition(e),t instanceof HTMLElement?(this.content.innerHTML="",this.content.appendChild(t)):this.content.innerHTML=t,this.container.style.display="block",this.panMapIfOutOfView&&this.panIntoView_(e),this.content.scrollTop=0,this},ol.Overlay.Popup.prototype.panIntoView_=function(e){var t={width:this.getElement().clientWidth+20,height:this.getElement().clientHeight+20},o=this.getMap().getSize(),r=20,n=60,i=t.width-n,a=this.getOffset(),s=this.getMap().getPixelFromCoordinate(e),l=s[0]-n,u=o[0]-(s[0]+i),c=s[1]-t.height+a[1],p=o[1]-(s[1]+r)-a[1],g=this.getMap().getView().getCenter(),y=this.getMap().getPixelFromCoordinate(g),m=y.slice();return 0>u?m[0]-=u:0>l&&(m[0]+=l),0>c?m[1]+=c:0>p&&(m[1]-=p),this.ani&&this.ani_opts&&(this.ani_opts.source=g,this.getMap().beforeRender(this.ani(this.ani_opts))),(m[0]!==y[0]||m[1]!==y[1])&&this.getMap().getView().setCenter(this.getMap().getCoordinateFromPixel(m)),this.getMap().getView().getCenter()},ol.Overlay.Popup.prototype.hide=function(){return this.container.style.display="none",this},ol.Overlay.Popup.prototype.isOpened=function(){return"block"==this.container.style.display}}(),function(){function e(e,t){mapService_.getMap().on("singleclick",function(a){goog.isDefAndNotNull(c)||(c=mapService_.getMap().getOverlays().array_[0].getElement(),t(c)(e)),service_.hide(),o=[],n=null,i=null,s=null,r=null;var l=[],u=mapService_.getMap().getView(),p=mapService_.getStoryLayers().getArray(),g=0,y=0;goog.array.forEach(p,function(e){var t=e.getLayer().getSource();goog.isDefAndNotNull(t.getGetFeatureInfoUrl)&&g++});var m=function(){if(y++,y===g){if(l.length>0){var e=a.coordinate;service_.show(l,e)}}else service_.hide(),n=null,i=null,s=null,r=null,o=[]};goog.array.forEach(p,function(e,t){var o=e.getLayer().getSource();if(goog.isDefAndNotNull(o.getGetFeatureInfoUrl)){var r=o.getGetFeatureInfoUrl(a.coordinate,u.getResolution(),u.getProjection(),{INFO_FORMAT:"application/json",FEATURE_COUNT:5});httpService_.get(r).then(function(e){var o={};o.features=e.data.features,o.features&&o.features.length>0&&goog.isDefAndNotNull(p[t])&&(o.layer=p[t],goog.array.insert(l,o)),m()},function(){m()})}})})}var t=angular.module("storytools.core.ogc.services",[]),o=[],r="",n=null,i=null,a=null,s=null,l=null,u=!0,c=null,p=null;t.provider("stFeatureInfoService",function(){function t(e){var t="";return goog.isDefAndNotNull(e)&&(e.properties?t="feature":e.features?t="layer":e.length&&e[0].features&&(t="layers")),console.log(t),t}this.$get=["$rootScope","$q","MapManager","$compile","$http",function(t,o,r,n,i){return rootScope_=t,service_=this,mapService_=r.storyMap,httpService_=i,q_=o,e(t,n),p=new ol.Overlay({insertFirst:!1,element:document.getElementById("info-box")}),mapService_.getMap().addOverlay(p),rootScope_.$on("rangeChange",function(){goog.isDefAndNotNull(service_.getSelectedLayer())&&service_.hide()}),this}],this.show=function(e,i){if(!goog.isDefAndNotNull(e))return!1;var u=n,c=t(e);if(0===o.length)if("feature"===c)o.push({features:[e],layer:a});else if("layer"===c)o.push(e);else{if("layers"!==c)throw{name:"featureInfoBox",level:"High",message:"Expected layers, layer, or feature.",toString:function(){return this.name+": "+this.message}};o=e}if("feature"===c)r="feature",n=e;else if("layer"===c)1===e.features.length?(r="feature",n=e.features[0]):(r="layer",n=e);else{if("layers"!==c)throw{name:"featureInfoBox",level:"High",message:"Invalid item passed in. Expected layers, layer, or feature.",toString:function(){return this.name+": "+this.message}};1===e.length?1===e[0].features.length?(r="feature",n=e[0].features[0]):(r="layer",n=e[0]):(r="layers",n=e)}if(n!==u&&"feature"===t(n)){a=this.getSelectedItemLayer().layer;var p={},g=[];goog.object.forEach(n.properties,function(e,t){p[t]=[t,e]});var y=null;for(y in p)p.hasOwnProperty(y)&&g.push(p[y]);s=g,console.log("---- selectedItemProperties_: ",s)}goog.isDefAndNotNull(i)&&(l=i,mapService_.getMap().getOverlays().array_[0].setPosition(l))},this.getSelectedItemLayer=function(){for(var e=0;e<o.length;e++)for(var t=0;t<o[e].features.length;t++)if(console.log(o[e].features[t]===n),console.log(o[e].features[t]),console.log(n),o[e].features[t].id===n.id)return o[e];return null},this.showPreviousState=function(){this.show(this.getPreviousState().item)},this.getPreviousState=function(){var e=null,t=null;if("feature"===r){var n=this.getSelectedItemLayer();if(!n)throw{name:"featureInfoBox",level:"High",message:"Could not find feature!",toString:function(){return this.name+": "+this.message}};n.features.length>1?(e="layer",t=n):1===n.features.length&&o.length>1&&(t=o,e="layers")}else"layer"===r&&o.length>1&&(e="layers",t=o);return null!==t?{state:e,item:t}:""},this.getState=function(){return r},this.getSelectedItem=function(){return n},this.getMediaUrl=function(e){var t=e;return goog.isString(e)&&-1===e.indexOf("http")&&(t=configService_.configuration.fileserviceUrlTemplate.replace("{}",e)),t},this.getSelectedItemMedia=function(){return i},this.getSelectedItemMediaByProp=function(e){var o=null;return"feature"===t(n)&&goog.isDefAndNotNull(n)&&goog.isDefAndNotNull(s)&&goog.object.forEach(s,function(t){service_.isMediaPropertyName(t[0])&&(goog.isDefAndNotNull(e)&&e!==t[0]||(goog.isDefAndNotNull(o)||(o=[]),goog.object.forEach(t[1],function(e){o.push(e)})))}),o},this.isMediaPropertyName=function(e){var t=e.toLowerCase();return 0===t.indexOf("fotos")||0===t.indexOf("photos")||0===t.indexOf("audios")||0===t.indexOf("videos")},this.getMediaTypeFromPropertyName=function(e){var t=e.toLowerCase(),o=null;return 0===t.indexOf("fotos")||0===t.indexOf("photos")?o="photos":0===t.indexOf("audios")?o="audios":0===t.indexOf("videos")&&(o="videos"),o},this.getMediaUrlThumbnail=function(e){var t=e;if(goog.isDefAndNotNull(e)&&"string"==typeof e){var o=e.split(".").pop().split("/")[0];t=supportedVideoFormats_.indexOf(o)>=0?service_.getMediaUrlDefault():service_.getMediaUrl(e)}return t},this.getMediaUrlDefault=function(){return"/static/maploom/assets/media-default.png"},this.getMediaUrlError=function(){return"/static/maploom/assets/media-error.png"},this.getSelectedItemProperties=function(){return s},this.setSelectedItemProperties=function(e){s=e},this.getSelectedLayer=function(){return a},this.getPosition=function(){return l},this.getEnabled=function(){return u},this.hide=function(){n=null,i=null,s=null,r=null,o=[],mapService_.getMap().getOverlays().array_[0].setPosition(void 0)}})}(),function(){"use strict";angular.module("storytools.core.style",["storytools.core.style.ol3StyleConverter","storytools.core.style.svgIcon"])}(),function(){"use strict";var e=angular.module("storytools.core.style.ol3StyleConverter",[]);e.factory("ol3MarkRenderer",["ol3StyleConverter",function(e){return function(t,o){var r=e.getColor("#000000"),n=3,i={color:r,width:n},a=angular.element(e.generateShape({symbol:{shape:t,size:o-n}},new ol.style.Fill(i),new ol.style.Stroke(i)).getImage());return a}}]),e.factory("ol3StyleConverter",["stSvgIcon",function(e){return{generateShapeConfig:function(e,t,o){var r=e.symbol.shape,n=e.symbol.size/2;return"circle"===r?{fill:t,stroke:o,radius:n}:"square"===r?{fill:t,stroke:o,points:4,radius:n,angle:Math.PI/4}:"triangle"===r?{fill:t,stroke:o,points:3,radius:n,angle:0}:"star"===r?{fill:t,stroke:o,points:5,radius:n,radius2:.5*n,angle:0}:"cross"===r?{fill:t,stroke:o,points:4,radius:n,radius2:0,angle:0}:"x"===r?{fill:t,stroke:o,points:4,radius:n,radius2:0,angle:Math.PI/4}:void 0
},calculateRotation:function(e,t){return e.symbol&&e.symbol.rotationAttribute?"radians"===e.symbol.rotationUnits?t.get(e.symbol.rotationAttribute):t.get(e.symbol.rotationAttribute)/360*Math.PI:void 0},generateShape:function(t,o,r,n){var i=this.generateShapeConfig(t,o,r);if(i&&n&&(i.rotation=this.calculateRotation(t,n)),t.symbol.graphic){var a=e.getImage(t.symbol.graphic,o.getColor(),r.getColor(),!0);return new ol.style.Icon({src:a.dataURI,rotation:this.calculateRotation(t,n),scale:t.symbol.size/Math.max(a.width,a.height),opacity:t.symbol.opacity})}return"circle"===t.symbol.shape?new ol.style.Circle(i):new ol.style.RegularShape(i)},getText:function(e,t){return e.label&&e.label.attribute?""+t.get(e.label.attribute):void 0},generateText:function(e,t,o){return e.label&&null!==e.label.attribute?new ol.style.Text({fill:new ol.style.Fill({color:e.label.fillColor}),stroke:t,font:e.label.fontStyle+" "+e.label.fontWeight+" "+e.label.fontSize+"px "+e.label.fontFamily,text:this.getText(e,o)}):void 0},getColor:function(e,t){var o=ol.color.asArray(e);return void 0!==t&&(o=o.slice(),o[3]=t/100),"rgba("+o.join(",")+")"},generateCacheKey:function(e,t){var o=this.getText(e,t),r=e.classify&&e.classify.attribute?t.get(e.classify.attribute):void 0,n=e.symbol&&e.symbol.rotationAttribute?t.get(e.symbol.rotationAttribute):void 0;return o+"|"+r+"|"+n},generateStyle:function(e,t){var o,r;this.styleCache_||(this.styleCache_={});var n=JSON.stringify(e);if(this.styleCache_[n]){if(this.styleCache_[n].length)return this.styleCache_[n];if(r=this.generateCacheKey(e,t),this.styleCache_[n][r])return this.styleCache_[n][r]}var i;if(e.stroke){var a;"dashed"===e.stroke.strokeStyle?a=[5]:"dotted"===e.stroke.strokeStyle&&(a=[1,2]),i=new ol.style.Stroke({lineDash:a,color:this.getColor(e.stroke.strokeColor,e.stroke.strokeOpacity),width:e.stroke.strokeWidth})}if(e.classify&&null!==e.classify.attribute){for(var s,l=0,u=e.rules.length;u>l;++l){var c=e.rules[l],p=t.get(e.classify.attribute),g=!1;void 0!==c.value?g=p===c.value:c.range&&(g=p>=c.range.min&&p<=c.range.max),g&&(s=this.generateText(e,i,t),"point"===e.geomType&&c.style.symbol.fillColor?o=[new ol.style.Style({text:s,image:this.generateShape(e,new ol.style.Fill({color:c.style.symbol.fillColor}),i,t)})]:"line"===e.geomType&&c.style.stroke.strokeColor?o=[new ol.style.Style({text:s,stroke:new ol.style.Stroke({color:c.style.stroke.strokeColor,width:2})})]:"polygon"===e.geomType&&c.style.symbol.fillColor&&(o=[new ol.style.Style({text:s,stroke:i,fill:new ol.style.Fill({color:c.style.symbol.fillColor})})]))}o&&(this.styleCache_[n]||(this.styleCache_[n]={}),r=this.generateCacheKey(e,t),this.styleCache_[n][r]=o)}else{var y=new ol.style.Fill({color:this.getColor(e.symbol.fillColor,e.symbol.fillOpacity)});o=[new ol.style.Style({image:this.generateShape(e,y,i,t),fill:y,stroke:i,text:this.generateText(e,i,t)})]}if(o){var m=o[0].getText();m||e.classify&&e.classify.attribute||e.symbol&&e.symbol.rotationAttribute?(this.styleCache_[n]||(this.styleCache_[n]={}),r=this.generateCacheKey(e,t),this.styleCache_[n][r]=o):this.styleCache_[n]=o}return o}}}])}(),function(){"use strict";var e=angular.module("storytools.core.style.svgIcon",[]);e.factory("stSvgIcon",["$cacheFactory","$http","$q","$log",function(e,t,o,r){function n(e,t,o){i.html(e),["path","polygon","circle","ellipse","rect","line","polyline"].forEach(function(e){angular.forEach(i.find(e),function(e){e=angular.element(e);var r={opacity:1},n=e.css("fill")||e.attr("fill")||"";"none"!=n&&"rgb(255, 255, 255)"!=n&&"#ffffff"!=n.toLowerCase()&&(r.fill=t);var i=e.css("stroke")||e.attr("stroke");"none"!=i&&(r.stroke=o),e.css(r)})});var r=i.find("svg"),n=parseInt(r.attr("width")),a=parseInt(r.attr("height"));(isNaN(n)||isNaN(a))&&(r.attr("width",64),r.attr("height",64),n=64,a=64);var s="data:image/svg+xml;base64,"+btoa(i.html());return{dataURI:s,width:n,height:a}}var i=angular.element(document.createElement("div")),a=e("stSvgImage"),s=e("stSvgData");return{getImage:function(e,t,i,l){var u=e+t+i,c=a.get(u),p=o.defer();if(c){if(l)return c;p.resolve(c)}else{if(l){var g=s.get(e);if(g){var y=n(g,t,i);return y.uri=e,a.put(u,y),y}return r.warning("no svg for",e),null}this.getImageData(e).then(function(o){var r=n(o.data,t,i);r.uri=e,a.put(u,r),p.resolve(r)},function(){p.reject("error")})}return p.promise},getImageData:function(e){return t.get(e,{cache:!0}).success(function(t){return s.put(e,t),t}).error(function(){r.warn("error fetching "+e)})}}}])}(),function(){var e=angular.module("loom_media_service",[]),t=null,o=null,r=null,n=null;e.config(["$sceDelegateProvider",function(e){e.resourceUrlWhitelist(["self",new RegExp(/https?:\/\/.*\.flickr\.com\/photos\/.*/),new RegExp(/https?:\/\/flic\.kr\/p\/.*/),new RegExp(/https?:\/\/instagram\.com\/p\/.*/),new RegExp(/https?:\/\/instagr\.am\/p\/.*/),new RegExp(/https?:\/\/vine\.co\/v\/.*/),new RegExp(/https?:\/\/(?:www\.)?vimeo\.com\/.+/),new RegExp(/https?:\/\/((?:www\.)|(?:pic\.)?)twitter\.com\/.*/),new RegExp(/https?:\/\/(?:w{3}\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com).+/im),new RegExp(/https?:\/\/(w{3}\.)?soundcloud\.com\/.+/im),new RegExp(/https?:\/\/(?:((?:m)\.)|((?:www)\.)|((?:i)\.))?imgur\.com\/?.+/im)])}]),e.provider("mediaService",function(){function e(e,t){var o,r="https://noembed.com/embed?url="+e,n="";for(o in t)null!==t[o]&&(n+="&"+encodeURIComponent(o)+"="+t[o]);return r+=n}function i(t,o){var n=r.defer(),i=e(t,o);return http_.jsonp(sce_.trustAsResourceUrl(i),{jsonCallbackParam:"cb",headers:{"Content-Type":"application/json"}}).then(function(e){n.resolve(e.data.html)},function(e){console.log("error",e)}),n.promise}function a(e,t){var o=r.defer(),n=/(https?:\/\/(\w+\.)?imgur\.com)/gi,i=e.match(n),a="";if(i.length>1)a='<iframe src="'+e+'" width="'+t.maxwidth+'" height="'+t.maxheight+'"></iframe>';else{var s=/https?:\/\/imgur\.com\/(?:\w+)\/?(.*?)(?:[#\/].*|$)/i;a=e.replace(s,'<blockquote class="imgur-embed-pub" lang="en" data-id="a/$1"></blockquote><script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script>')}return o.resolve(a),o.promise}this.$get=["$rootScope","$http","$q","$sce",function(e,i,a,s){return http_=i,r=a,t=this,sce_=s,http_.jsonp(s.trustAsResourceUrl("https://noembed.com/providers"),{jsonCallbackParam:"cb",headers:{"Content-Type":"application/json"}}).then(function(e){n=e.data}),o=t.configureDefaultHandlers(),t}],this.isNOEmbedProvided=function(e){for(var t=0;t<n.length;t+=1)for(var o=n[t],r=0;r<o.patterns.length;r+=1){var i=new RegExp(o.patterns[r],"i");if(null!==e.match(i))return!0}return!1},this.configureDefaultHandlers=function(){var e=[{name:"imgur",regex:/(https?:\/\/(\w+\.)?imgur\.com)/i,callback:a}];return e},this.isUrl=function(e){return/^(f|ht)tps?:\/\//i.test(e)?!0:!1},this.getEmbedContent=function(e,r){for(var n='<a href="'+e+'"> Unable to Embed Content </a>',a=0;a<o.length;a+=1){var s=o[a];if(s.regex.test(e))return s.callback(e,r)}return null!==t.isNOEmbedProvided(e)?i(e,r):n}})}(),function(){"use strict";function e(e){this.storyPins=[],this.map=null,n=e}var t=angular.module("storytools.core.pins",[]),o=storytools.core.maps.pins,r=storytools.core.time.utils,n=null;e.$inject=["$rootScope"],e.prototype.autoDisplayPins=function(e){for(var t=this.storyPins.filter(function(e){return e.get("auto_show")}),o=0;o<t.length;o+=1){var i=t[o],a=r.createRange(i.start_time,i.end_time);a.intersects(e)?n.$broadcast("showPin",i):n.$broadcast("hidePinOverlay",i)}},e.prototype.pinsChanged=function(e,t){var o;if("delete"==t){for(o=0;o<e.length;o++)for(var r=e[o],n=0,i=this.storyPins.length;i>n;n++)if(this.storyPins[n].id==r.id){this.storyPins.splice(n,1);break}}else if("add"==t)for(o=0;o<e.length;o++)this.storyPins.push(e[o]);else if("change"!=t)throw new Error("action? :"+t);var a=this.storyPins.map(function(e){return e.start_time>e.end_time?storytools.core.utils.createRange(e.end_time,e.start_time):storytools.core.utils.createRange(e.start_time,e.end_time)});this.map.storyPinsLayer.set("times",a),this.map.storyPinsLayer.set("features",this.storyPins)},e.prototype.clear=function(){this.storyPins=[],this.map.storyPinsLayer.set("times",[]),this.map.storyPinsLayer.set("features",this.storyPins)},e.prototype.loadFromGeoJSON=function(e,t,r){if(r&&(this.storyPins=[]),e&&e.features){var n=o.loadFromGeoJSON(e,t);this.pinsChanged(n,"add",!0)}},t.service("StoryPinLayerManager",e),t.constant("StoryPin",o.StoryPin),t.service("stAnnotationsStore",["StoryPinLayerManager",function(e){function t(e){return"/maps/"+e+"/annotations"}function o(e){var o=localStorage.getItem(t(e));return o=null===o?[]:JSON.parse(o)}function r(e,o){localStorage.setItem(t(e),(new ol.format.GeoJSON).writeFeatures(o,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}return{loadAnnotations:function(t,r){return e.loadFromGeoJSON(o(t),r)},deleteAnnotations:function(e){var t=o(),n=e.map(function(e){return e.id});t=t.filter(function(e){return n.indexOf(e.id)<0}),r(t)},saveAnnotations:function(e,t){var n=o(),i=0;n.forEach(function(e){i=Math.max(i,e.id)});var a=[];t.forEach(function(e){"undefined"==typeof e.id&&(e.id=++i);var t=e.clone();void 0!==e.get("start_time")&&t.set("start_time",e.get("start_time")/1e3),void 0!==e.get("end_time")&&t.set("end_time",e.get("end_time")/1e3),a.push(t)}),r(e,a)}}}])}(),function(){"use strict";var e=angular.module("storytools.core.time.directives",[]);e.directive("stPlaybackControls",function(){return{restrict:"E",templateUrl:"time/playback-controls.html",scope:{timeControls:"=",playbackOptions:"="},link:function(e){e.playbackState="Play",e.loopText="Loop Chapter",e.loopStoryEnabled=!1,e.loopChapterEnabled=!1,e.showTimeLine=!1,e.next=function(){e.timeControls.next()},e.prev=function(){e.timeControls.prev()},e.$watch("timeControls",function(t,o){t!==o&&(t.on("stateChange",function(){var t=e.timeControls.isStarted();e.started=t,e.playbackState=t?"Pause":"Play",e.$apply()}),t.on("rangeChange",function(t){e.currentRange=t,e.$apply()}))}),e.$on("pausePlayback",function(){var t=e.timeControls,o=t.isStarted();o&&t.stop()}),e.play=function(){var t=e.timeControls,o=t.isStarted();o?t.stop():t.start()},e.isInFullScreen=function(e){return void 0!==e.fullScreenElement?!!e.fullScreenElement:void 0!==e.mozFullScreen?!!e.mozFullScreen:void 0!==e.webkitIsFullScreen?!!e.webkitIsFullScreen:void 0!==window.fullScreen?!!window.fullScreen:void 0!==window.navigator.standalone?!!window.navigator.standalone:void 0},e.toggleFullScreen=function(){var e=window.parent.document.getElementById("embedded_map");this.isInFullScreen(document)||this.isInFullScreen(parent.document)?document.mozCancelFullScreen?(parent.document.mozCancelFullScreen(),document.mozCancelFullScreen()):(parent.document.webkitCancelFullScreen(),document.webkitCancelFullScreen()):document.webkitFullScreen&&document.mozFullScreen&&document.msFullscreenElement&&document.fullscreenElement||(e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT))},e.toggleLoop=function(){var t=e.timeControls;"none"===t.loop?(e.loop=t.loop="chapter",e.loopText="Loop Story",e.loopChapterEnabled=!0):"chapter"===t.loop?(e.loop=t.loop="story",e.loopText="Disable Loop",e.loopStoryEnabled=!0,e.loopChapterEnabled=!1):(e.loopText="Loop Chapter",e.loop=t.loop="none",e.loopStoryEnabled=!1,e.loopChapterEnabled=!1)},e.getLoopButtonGlyph=function(){return"story"===e.loop?"glyphicon glyphicon-refresh":"glyphicon glyphicon-repeat"},e.toggleTimeLine=function(){var t=e.timeControls;e.showTimeLine=t.showTimeLine=!t.showTimeLine;var o=$("#timeline");t.showTimeLine?o.show("slow"):o.hide("slow")}}}}),e.directive("stPlaybackSettings",function(){return{restrict:"E",templateUrl:"time/playback-settings.html",scope:{timeControls:"=",playbackOptions:"="},link:function(e){e.optionsChanged=function(){e.timeControls&&e.timeControls.update(e.playbackOptions)}}}})}(),function(){"use strict";var e=angular.module("storytools.core.time",["storytools.core.time.directives","storytools.core.time.services","storytools.core.templates"]);e.filter("isodate",function(){return function(e){return null!==e&&angular.isDefined(e)?angular.isNumber(e)?new Date(e).toISOString():Date.parse(e).toISOString():""}})}(),function(){"use strict";function e(e){function t(e){e=r.getTime(e),null===e||e in n||(n[e]=1)}if(!angular.isArray(e)){var o=e;e=o.getStoryLayers().getArray().filter(function(e){var t=e.get("times");return null!=t}),e.push(o.storyPinsLayer),e.push(o.storyBoxesLayer)}var n={},i=null,a=[];if(e.forEach(function(e){var o,n=e.get("times");angular.isArray(n)?(o=r.computeRange(n),n.length&&n.forEach(r.isRangeLike(n[0])?function(e){t(e.start),null===i?i=r.createRange(e):i.extend(e)}:function(e){t(e)}),null!=o.end&&t(o.end)):n&&(o=n,a.push(n)),null===i?i=r.createRange(o):i.extend(o)}),a.length){a.sort(function(e,t){return e.interval-t.interval});for(var s=a[0],l=i.start;l<=i.end;)t(l),l=s.offset(l)}return n=Object.getOwnPropertyNames(n).map(function(e){return parseInt(e)}),n.sort(function(e,t){return e-t})}function t(t,o,r,n){function i(t){if(null===a.timeControls){var i=e(n.storyMap);if(i.length){var s=r.storyPins;a.timeControls=storytools.core.time.create({annotations:s,storyMap:n.storyMap,storyLayers:n.storyMap.getStoryLayers().getArray(),data:i,mode:n.storyMap.mode,tileStatusCallback:function(e){o.$broadcast("tilesLoaded",e)},chapterCount:n.chapterCount}),a.timeControls.on("rangeChange",function(e){a.currentRange=e,o.$broadcast("rangeChange",e)})}}else if(t){var l=t();l&&a.timeControls.update(l)}}this.timeControls=null;var a=this;n.storyMap.getStoryLayers().on("change:length",function(){i(function(){var t=e(n.storyMap);return t.length>=0?{storyLayers:n.storyMap.getStoryLayers().getArray(),data:t}:void 0})});var s=n.storyMap.storyPinsLayer,l=n.storyMap.storyBoxesLayer;s.on("change:features",function(){i(function(){var t=e(n.storyMap);return t.length>=0?{annotations:s.get("features"),data:t}:void 0})}),l.on("change:features",function(){i(function(){var t=e(n.storyMap);return t.length>=0?{boxes:l.get("features"),data:t}:void 0})}),i()}var o=angular.module("storytools.core.time.services",[]),r=storytools.core.time.utils;o.constant("TimeControlsManager",t),o.service("TimeMachine",function(){return{computeTicks:e}})}(),function(){"use strict";var e=angular.module("storytools.core.mapstory.localStorageSvc",[]);e.service("stLocalStorageSvc",["$http",function(){function e(e){return"/maps/"+e}var t={};return t.get=function(t){var o=localStorage.getItem(e(t));return o=null===o?{}:angular.fromJson(o)},t.set=function(t){localStorage.setItem(e(t.id),angular.toJson(t))},t.list=function(){var e=[],t=new RegExp("/maps/(\\d+)$");return Object.getOwnPropertyNames(localStorage).forEach(function(o){var r=t.exec(o);r&&e.push({id:r[1]})}),e},t.nextId=function(){var e=0,o=t.list().map(function(e){return e.id});return o.sort(),o.length&&(e=parseInt(o[o.length-1])),e+1},{listMaps:function(){return t.list()},loadConfig:function(e){return t.get(e)},saveConfig:function(e){angular.isDefined(e.id)||(e.id=t.nextId()),t.set(e)}}}])}(),function(){"use strict";var e=angular.module("storytools.core.mapstory.remoteStorageSvc",[]);e.factory("stRemoteStorageSvc",["$q","$http",function(){this.save=function(){}}])}(),function(){"use strict";angular.module("storytools.core.mapstory.services",["storytools.core.mapstory.localStorageSvc","storytools.core.mapstory.remoteStorageSvc"])}();